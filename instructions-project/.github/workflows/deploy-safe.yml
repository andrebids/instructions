name: Deploy Safe - Lightweight

# Workflow otimizado para não sobrecarregar o servidor
# Versão: 3.1 - Deploy leve com timeouts e concorrência limitada (sem rsync)
on:
  push:
    branches: [ master, main ]
  workflow_dispatch: {}

# Limitar a apenas 1 deploy por vez para evitar sobrecarga
concurrency:
  group: deploy-instructions
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 8  # Timeout total de 8 minutos
    
    steps:
      - name: Deploy via SSH (Lightweight)
        uses: appleboy/ssh-action@v1.2.0
        env:
          NODE_ENV: ${{ secrets.NODE_ENV }}
          PM2_NAME: ${{ secrets.PM2_NAME }}
          PORT: ${{ secrets.PORT }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 7m  # Timeout de 7 minutos por comando
          envs: NODE_ENV,PM2_NAME,PORT
          script: |
            set -e  # Parar em caso de erro
            
            PROJECT_ROOT="/home/andre/apps/instructions/instructions-project"
            SERVER_DIR="${PROJECT_ROOT}/server"
            CLIENT_DIR="${PROJECT_ROOT}/client"
            
            echo "[1/7] Verificando recursos do servidor..."
            uptime
            free -h | head -2
            echo ""
            
            echo "[2/7] Atualizando código (git pull)..."
            cd "${PROJECT_ROOT}"
            timeout 60 git fetch origin || exit 1
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            timeout 30 git reset --hard origin/${CURRENT_BRANCH:-main} || exit 1
            echo "OK: Codigo atualizado"
            echo ""
            
            echo "[3/7] Verificando Docker Compose..."
            cd "${PROJECT_ROOT}"
            timeout 30 docker compose -f docker-compose.prod.yml ps -q 2>/dev/null || docker compose -f docker-compose.prod.yml up -d || true
            echo "OK: Docker verificado"
            echo ""
            
            echo "[4/7] Configurando .env..."
            cd "${SERVER_DIR}"
            cat > .env << EOF
            DB_HOST=localhost
            DB_PORT=5433
            DB_NAME=instructions_demo
            DB_USER=demo_user
            DB_PASSWORD=demo_password
            PORT=${PORT:-5000}
            NODE_ENV=${NODE_ENV:-production}
            EOF
            echo "OK: .env configurado"
            echo ""
            
            echo "[5/7] Instalando dependencias do servidor (timeout 3min)..."
            cd "${SERVER_DIR}"
            # Usar timeout e limitar concorrência do npm
            timeout 180 npm ci --omit=dev --maxsockets=1 --prefer-offline || timeout 180 npm install --omit=dev --maxsockets=1 --prefer-offline || exit 1
            echo "OK: Dependencias do servidor instaladas"
            echo ""
            
            echo "[6/7] Build do cliente (timeout 5min)..."
            cd "${CLIENT_DIR}"
            # Instalar dependências em background para não bloquear
            timeout 180 npm ci --maxsockets=1 --prefer-offline || timeout 180 npm install --maxsockets=1 --prefer-offline || exit 1
            # Build com limite de memória
            NODE_OPTIONS="--max-old-space-size=2048" timeout 300 npm run build || exit 1
            echo "OK: Cliente compilado"
            echo ""
            
            echo "[7/7] Reiniciando PM2..."
            PM2_NAME_FINAL="${PM2_NAME:-instructions-server}"
            pm2 delete ${PM2_NAME_FINAL} 2>/dev/null || true
            cd "${SERVER_DIR}"
            pm2 start npm --name ${PM2_NAME_FINAL} -- start
            pm2 save
            sleep 3
            pm2 status
            echo ""
            echo "OK: Deploy concluido!"
            
            # Health check simples (não bloquear se falhar)
            timeout 5 curl -f http://localhost:5000/health > /dev/null 2>&1 && echo "OK: Servidor respondendo" || echo "AVISO: Health check falhou (servidor pode estar a iniciar)"

