services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: instructions-dev

    # Port mappings (avoiding conflicts)
    ports:
      - "5001:5000" # Backend API (mapped to 5001 to avoid conflict)
      - "3003:3003" # Vite dev server

    # Named volumes for better management and persistence
    volumes:
      # Bind mount source code for hot reload
      - ./:/app

      # Named volumes to isolate node_modules from Windows and improve performance
      - node_modules_root:/app/node_modules
      - node_modules_client:/app/client/node_modules
      - node_modules_server:/app/server/node_modules

      # Uploads directory será montado pelo SMB no script de inicialização
      # NÃO usar bind mount aqui para não sobrescrever o SMB montado

    # Environment variables
    environment:
      # Windows file watching with polling
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true

      # DNS resolution (from your NODE_OPTIONS)
      - NODE_OPTIONS=--dns-result-order=ipv4first

      # Development mode
      - NODE_ENV=development

      # API URL for frontend (porta 5001 é mapeada do container 5000)
      - VITE_API_URL=http://localhost:5001/api

      # Caminho específico para produtos (SMB montado pelo script de inicialização)
      - PRODUCTS_UPLOAD_PATH=/app/server/public/uploads/products
      
      # Caminho específico para projetos (SMB montado pelo script de inicialização)
      - PROJECTS_UPLOAD_PATH=/app/server/public/uploads/projects
      
      # Credenciais SMB para montar o TrueNAS (opcional - deixe vazio para guest)
      # Cada usuário pode configurar no arquivo .env ou remover para usar guest
      - SMB_USER=${SMB_USER:-guest}
      - SMB_PASS=${SMB_PASS:-}

    # Load additional environment variables from .env file
    env_file:
      - .env

    # Keep container running and show logs
    stdin_open: true
    tty: true

    # Capabilities needed for mounting SMB shares
    cap_add:
      - SYS_ADMIN
    
    # Device access for mounting
    devices:
      - /dev/fuse:/dev/fuse
    
    # Resource limits to prevent excessive resource usage
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    
    # Network optimization
    dns:
      - 8.8.8.8
      - 8.8.4.4
    
    # Logging configuration with rotation
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    
    # Restart policy
    restart: unless-stopped

    # Health check
    # Verifica o endpoint /health que testa a conexão com a base de dados
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Named volumes definition
volumes:
  node_modules_root:
    driver: local
  node_modules_client:
    driver: local
  node_modules_server:
    driver: local
